(function(){"use strict";const STORAGE_KEY="adam-ui-state-v2";const HEARTBEAT_INTERVAL=20000;const SAVE_DEBOUNCE=1200;const MAX_PREVIEW_LENGTH=140;const COMPOSER_MAX_LINES=10;const elements={app:document.querySelector(".app"),sidebar:document.getElementById("sidebar"),sidebarToggle:document.getElementById("sidebarToggle"),sidebarCollapse:document.getElementById("sidebarCollapse"),sidebarOverlay:document.getElementById("sidebarOverlay"),settingsPanel:document.getElementById("settingsPanel"),settingsToggle:document.getElementById("settingsToggle"),settingsClose:document.getElementById("settingsClose"),settingsDone:document.getElementById("settingsDone"),settingsStatusDot:document.getElementById("settingsStatusDot"),settingsStatusLabel:document.getElementById("settingsStatusLabel"),newChatButton:document.getElementById("newChatButton"),chatList:document.getElementById("chatList"),chatSearch:document.getElementById("chatSearch"),messageStream:document.getElementById("messageStream"),quickReplies:document.getElementById("quickReplies"),typingIndicator:document.getElementById("typingIndicator"),stopStreamButton:document.getElementById("stopStreamButton"),messageForm:document.getElementById("messageForm"),messageInput:document.getElementById("messageInput"),sendButton:document.getElementById("sendButton"),fileButton:document.getElementById("fileButton"),fileInput:document.getElementById("fileInput"),imageButton:document.getElementById("imageButton"),imageInput:document.getElementById("imageInput"),voiceButton:document.getElementById("voiceButton"),attachmentPreview:document.getElementById("attachmentPreview"),apiStatusDot:document.getElementById("apiStatusDot"),apiStatusLabel:document.getElementById("apiStatusLabel"),languageSelect:document.getElementById("languageSelect"),};const clone=(value)=>{if(typeof structuredClone==="function"){return structuredClone(value);}try{return JSON.parse(JSON.stringify(value));}catch{return value;}};const initialState={chats:{},currentChatId:null,quickReplies:[],searchQuery:"",preferences:{theme:"system",language:"en",sidebarCollapsed:false},pendingAttachments:[],pendingVoice:null,lastPrompt:null};let state=loadState();let messageElements=new Map();let activeController=null;let isStreaming=false;let lastSaveAt=0;let heartbeatTimer=null;let voiceRecorder=null;let voiceChunks=[];let offlineTooltip=null;init();function init(){applyTheme(state.preferences.theme,false);ensureChat();bindEvents();renderSidebar();renderActiveChat();fetchQuickReplies();syncComposerState();setStreaming(false);scheduleHeartbeat(true);updateConnectivity();window.requestAnimationFrame(()=>elements.messageInput&&autoResize(elements.messageInput));}
function bindEvents(){elements.newChatButton?.addEventListener("click",()=>createChat());elements.chatSearch?.addEventListener("input",(event)=>{state.searchQuery=event.target.value.toLowerCase();renderSidebar();});elements.sidebarToggle?.addEventListener("click",()=>{const open=elements.app.getAttribute("data-sidebar-open")!=="true";setSidebarOpen(open);});elements.sidebarCollapse?.addEventListener("click",toggleSidebarCollapsed);elements.sidebarOverlay?.addEventListener("click",()=>setSidebarOpen(false));elements.settingsToggle?.addEventListener("click",openSettings);elements.settingsClose?.addEventListener("click",closeSettings);elements.settingsDone?.addEventListener("click",closeSettings);elements.languageSelect?.addEventListener("change",(event)=>{state.preferences.language=event.target.value;persistState();});Array.from(elements.settingsPanel?.querySelectorAll("input[name=theme]" )||[]).forEach((radio)=>{radio.addEventListener("change",()=>{state.preferences.theme=radio.value;applyTheme(radio.value);persistState();});});elements.chatList?.addEventListener("click",handleChatListClick);elements.chatList?.addEventListener("dblclick",handleChatTitleRename);elements.messageForm?.addEventListener("submit",handleSubmit);elements.messageInput?.addEventListener("input",()=>{autoResize(elements.messageInput);state.lastPrompt=elements.messageInput.value;persistStateDebounced();});elements.messageInput?.addEventListener("keydown",(event)=>{if(event.key==="Enter"&&!event.shiftKey){event.preventDefault();handleSubmit(event);}});elements.fileButton?.addEventListener("click",()=>elements.fileInput?.click());elements.imageButton?.addEventListener("click",()=>elements.imageInput?.click());elements.fileInput?.addEventListener("change",(event)=>handleFileSelection(event.target.files,"file"));elements.imageInput?.addEventListener("change",(event)=>handleFileSelection(event.target.files,"image"));elements.voiceButton?.addEventListener("click",toggleVoiceRecording);const composer=elements.messageForm?.querySelector(".composer__bar");if(composer){["dragenter","dragover"].forEach((type)=>composer.addEventListener(type,(event)=>{event.preventDefault();composer.classList.add("is-drag-hover");}));["dragleave","drop"].forEach((type)=>composer.addEventListener(type,(event)=>{event.preventDefault();composer.classList.remove("is-drag-hover");if(type==="drop"){const files=event.dataTransfer?.files;if(files?.length){handleFileSelection(files,detectDropKind(files));}}}));}
elements.stopStreamButton?.addEventListener("click",sendStopRequest);elements.sendButton?.addEventListener("click",(event)=>{if(isStreaming){event.preventDefault();sendStopRequest();}});window.addEventListener("online",updateConnectivity);window.addEventListener("offline",updateConnectivity);window.matchMedia("(max-width: 768px)").addEventListener("change",(event)=>{if(!event.matches){setSidebarOpen(true);}else{setSidebarOpen(false);}});document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="visible"){scheduleHeartbeat(true);}});}
function openSettings(){if(!elements.settingsPanel)return;elements.settingsPanel.hidden=false;elements.settingsPanel.setAttribute("data-open","true");elements.settingsPanel.focus();}
function closeSettings(){if(!elements.settingsPanel)return;elements.settingsPanel.removeAttribute("data-open");elements.settingsPanel.hidden=true;}
function detectDropKind(fileList){if(!fileList.length){return"file";}const onlyImages=Array.from(fileList).every((file)=>file.type.startsWith("image/"));return onlyImages?"image":"file";}
function toggleSidebarCollapsed(){state.preferences.sidebarCollapsed=!state.preferences.sidebarCollapsed;applySidebarCollapsedState();persistState();}
function applySidebarCollapsedState(){const collapsed=!!state.preferences.sidebarCollapsed;if(elements.app){elements.app.setAttribute("data-sidebar-collapsed",String(collapsed));}if(elements.sidebarCollapse){elements.sidebarCollapse.setAttribute("aria-pressed",collapsed?"true":"false");const label=collapsed?"Expand sidebar":"Collapse sidebar";elements.sidebarCollapse.setAttribute("aria-label",label);elements.sidebarCollapse.title=label;elements.sidebarCollapse.textContent=collapsed?"â‡¥":"â‡¤";}}
function setSidebarOpen(open){elements.app.setAttribute("data-sidebar-open",open?"true":"false");}
function loadState(){try{const raw=localStorage.getItem(STORAGE_KEY);if(!raw)return clone(initialState);const parsed=JSON.parse(raw);return{...clone(initialState),...parsed,preferences:{...clone(initialState.preferences),...(parsed.preferences||{})},pendingAttachments:[],pendingVoice:null};}catch(error){console.warn("Failed to load state",error);return clone(initialState);}}
function persistState(){try{const payload={chats:state.chats,currentChatId:state.currentChatId,quickReplies:state.quickReplies,searchQuery:state.searchQuery,preferences:state.preferences,lastPrompt:state.lastPrompt};localStorage.setItem(STORAGE_KEY,JSON.stringify(payload));lastSaveAt=Date.now();}catch(error){console.warn("Failed to persist state",error);}}
function persistStateDebounced(){if(Date.now()-lastSaveAt>SAVE_DEBOUNCE){persistState();return;}window.clearTimeout(persistStateDebounced.timer);persistStateDebounced.timer=window.setTimeout(persistState,SAVE_DEBOUNCE);}
function ensureChat(){if(state.currentChatId&&state.chats[state.currentChatId])return;const chatId=createId("chat");state.chats[chatId]=createChatObject({id:chatId});state.currentChatId=chatId;persistState();}
function createChatObject({id,title}){return{id,title:title||"New chat",createdAt:Date.now(),updatedAt:Date.now(),messages:[],tags:[],quickRepliesVisible:false};}
function createChat(title){const chatId=createId("chat");state.chats[chatId]=createChatObject({id:chatId,title});state.currentChatId=chatId;state.searchQuery="";state.quickReplies=[];elements.chatSearch&&(elements.chatSearch.value="");state.pendingAttachments=[];state.pendingVoice=null;state.lastPrompt="";persistState();renderSidebar();renderActiveChat();setSidebarOpen(false);}
function deleteChat(chatId){if(!state.chats[chatId])return;delete state.chats[chatId];if(state.currentChatId===chatId){ensureChat();}persistState();renderSidebar();renderActiveChat();}
function renameChat(chatId,title){const chat=state.chats[chatId];if(!chat)return;chat.title=title.slice(0,80)||"Untitled";chat.updatedAt=Date.now();persistState();renderSidebar();}
function handleChatListClick(event){const target=event.target;const item=target.closest("li[data-chat-id]");if(!item)return;const chatId=item.dataset.chatId;if(target.closest("button[data-delete]")&&chatId){deleteChat(chatId);return;}if(state.currentChatId!==chatId){state.currentChatId=chatId;persistState();renderSidebar();renderActiveChat();if(window.matchMedia("(max-width: 768px)").matches){setSidebarOpen(false);}}}
function handleChatTitleRename(event){const titleEl=event.target.closest("button[data-role=chat-title]");if(!titleEl)return;const chatId=titleEl.closest("li[data-chat-id]")?.dataset.chatId;if(!chatId)return;const chat=state.chats[chatId];const proposed=prompt("Rename chat",chat?.title||"New chat");if(!proposed)return;renameChat(chatId,proposed.trim());}
function renderSidebar(){const list=elements.chatList;if(!list)return;list.innerHTML="";const chats=Object.values(state.chats).sort((a,b)=>b.updatedAt-a.updatedAt);const query=state.searchQuery?.trim();const filtered=query?chats.filter((chat)=>matchesSearch(chat,query)):chats;filtered.forEach((chat)=>{const item=document.createElement("li");item.className="chat-item";item.dataset.chatId=chat.id;item.dataset.active=chat.id===state.currentChatId;const titleButton=document.createElement("button");titleButton.type="button";titleButton.dataset.role="chat-title";titleButton.className="chat-item__title";titleButton.textContent=chat.title||"New chat";const meta=document.createElement("div");meta.className="chat-item__meta";meta.innerHTML=`<span>${formatRelative(chat.updatedAt)}</span>`;const preview=document.createElement("div");preview.className="chat-item__preview";preview.textContent=derivePreview(chat);const remove=document.createElement("button");remove.type="button";remove.dataset.delete="true";remove.className="chat-item__delete";remove.setAttribute("aria-label","Delete chat");remove.textContent="âœ•";item.append(titleButton,meta,preview,remove);list.appendChild(item);});if(!filtered.length){const empty=document.createElement("p");empty.className="chat-empty";empty.textContent=query?"No chats match your search":"Start chatting to see history";list.appendChild(empty);}elements.chatSearch&&(elements.chatSearch.value=state.searchQuery||"");applySidebarCollapsedState();}
function matchesSearch(chat,query){const q=query.toLowerCase();if((chat.title||"").toLowerCase().includes(q))return true;return chat.messages.some((msg)=>msg.content?.toLowerCase().includes(q));}
function derivePreview(chat){const last=chat.messages.at(-1);if(!last)return"No messages yet";const base=last.content?.replace(/\s+/g," ").trim()||"";return base.slice(0,MAX_PREVIEW_LENGTH)+(base.length>MAX_PREVIEW_LENGTH?"â€¦":"");}
function renderActiveChat(){const stream=elements.messageStream;if(!stream)return;stream.innerHTML="";messageElements=new Map();const chat=state.chats[state.currentChatId];if(!chat){return;}chat.messages.forEach((message)=>{appendMessageElement(message,false);});stream.scrollTop=stream.scrollHeight;renderQuickReplies(chat);syncComposerState();}
function renderQuickReplies(chat){if(!elements.quickReplies)return;const replies=chat.quickReplies||state.quickReplies;if(!replies?.length){elements.quickReplies.classList.add("hidden");elements.quickReplies.innerHTML="";return;}elements.quickReplies.classList.remove("hidden");elements.quickReplies.innerHTML="";replies.slice(0,3).forEach((text)=>{const button=document.createElement("button");button.type="button";button.className="quick-reply";button.dataset.reply=text;button.textContent=text;button.addEventListener("click",()=>{if(isStreaming)return;elements.messageInput.value=text;autoResize(elements.messageInput);handleSubmit(new Event("submit"));});elements.quickReplies.appendChild(button);});}
function appendMessageElement(message,scroll=true){const stream=elements.messageStream;if(!stream)return;const existing=messageElements.get(message.id);const node=createMessageElement(message);if(existing){existing.replaceWith(node);}else{stream.appendChild(node);}messageElements.set(message.id,node);if(scroll){requestAnimationFrame(()=>{stream.scrollTop=stream.scrollHeight;});}}
function createMessageElement(message,replace=false){const wrapper=document.createElement("article");wrapper.className="message";wrapper.dataset.role=message.role;wrapper.dataset.messageId=message.id;const avatar=document.createElement("div");avatar.className="message__avatar";avatar.textContent=message.role==="assistant"?"ðŸ¤–":"ðŸ™‚";const bubble=document.createElement("div");bubble.className="message__bubble";if(message.error){bubble.classList.add("message__bubble--error");}const body=document.createElement("div");body.className="message__body";renderMarkdown(body,message.content||"");if(message.attachments?.length){body.appendChild(renderMessageAttachments(message.attachments));}
if(message.rich?.chartSpec){body.appendChild(renderChart(message.rich.chartSpec));}
if(message.rich?.images?.length){body.appendChild(renderGeneratedImages(message.rich.images));}
const meta=document.createElement("footer");meta.className="message__meta";meta.appendChild(document.createTextNode(formatRelative(message.createdAt)));if(message.sources?.length){meta.appendChild(renderSources(message.sources));}
const controls=document.createElement("div");controls.className="message__controls";if(message.role==="assistant"){controls.appendChild(renderFeedbackButtons(message));const actions=document.createElement("div");actions.className="message__actions";const regen=document.createElement("button");regen.type="button";regen.className="message__regenerate";regen.textContent="â†©ï¸ Regenerate";regen.addEventListener("click",()=>handleRegenerate(message));actions.appendChild(regen);controls.appendChild(actions);}bubble.append(body);if(message.needsCollapse){wrapper.classList.add("message--collapsed");body.dataset.collapsed="true";const toggle=document.createElement("button");toggle.type="button";toggle.className="message__expand";toggle.textContent="â–¼ Continue readingâ€¦";toggle.addEventListener("click",()=>{const collapsed=body.dataset.collapsed==="true";body.dataset.collapsed=collapsed?"false":"true";toggle.textContent=collapsed?"â–² Show less":"â–¼ Continue readingâ€¦";});bubble.appendChild(toggle);}bubble.appendChild(meta);if(controls.childNodes.length){bubble.appendChild(controls);}wrapper.append(avatar,bubble);return wrapper;}
function renderMessageAttachments(attachments){const container=document.createElement("div");container.className="message__attachments";attachments.forEach((file)=>{const item=document.createElement("div");item.className="message__attachment";if(file.preview){const img=document.createElement("img");img.src=file.preview;img.alt=file.name||"Attachment";img.loading="lazy";item.appendChild(img);}const text=document.createElement("span");text.textContent=file.name?`${file.name} Â· ${formatBytes(file.size||0)}`:"Attachment";item.appendChild(text);if(file.url){const link=document.createElement("a");link.href=file.url;link.target="_blank";link.rel="noopener";link.textContent="Open";item.appendChild(link);}container.appendChild(item);});return container;}
function renderGeneratedImages(images){const container=document.createElement("div");container.className="message__attachments";images.forEach((src,index)=>{const figure=document.createElement("figure");figure.className="message__attachment";const img=document.createElement("img");img.src=src;img.alt=`Generated image ${index+1}`;img.loading="lazy";img.addEventListener("click",()=>openLightbox(src));figure.appendChild(img);container.appendChild(figure);});return container;}
function openLightbox(src){const overlay=document.createElement("div");overlay.className="lightbox";overlay.style.position="fixed";overlay.style.inset="0";overlay.style.background="rgba(15,23,42,0.8)";overlay.style.display="flex";overlay.style.alignItems="center";overlay.style.justifyContent="center";overlay.style.zIndex="40";const img=document.createElement("img");img.src=src;img.style.maxWidth="90vw";img.style.maxHeight="90vh";img.style.borderRadius="16px";img.style.boxShadow="0 20px 60px rgba(0,0,0,0.35)";overlay.appendChild(img);overlay.addEventListener("click",()=>overlay.remove());document.body.appendChild(overlay);}
function renderFeedbackButtons(message){const wrapper=document.createElement("div");wrapper.className="feedback-buttons";const up=document.createElement("button");up.type="button";up.className="feedback-button";up.textContent="ðŸ‘";up.setAttribute("aria-label","Thumbs up");up.addEventListener("click",()=>sendFeedback(message,"up",up,down));const down=document.createElement("button");down.type="button";down.className="feedback-button";down.textContent="ðŸ‘Ž";down.setAttribute("aria-label","Thumbs down");down.addEventListener("click",()=>sendFeedback(message,"down",down,up));wrapper.append(up,down);return wrapper;}
async function sendFeedback(message,rating,button,other){button.disabled=true;other.disabled=true;try{await fetch("/feedback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message_id:message.id,rating})});button.textContent=rating==="up"?"âœ…":"âœ…";}catch(error){console.warn("Feedback failed",error);button.disabled=false;other.disabled=false;}}
function renderSources(sources){const wrapper=document.createElement("div");wrapper.className="citation-list";const label=document.createElement("span");label.textContent="ðŸ”— Sources:";wrapper.appendChild(label);sources.forEach((source,index)=>{const link=document.createElement("a");link.target="_blank";link.rel="noopener";link.href=source.url;link.textContent=source.title||`Source ${index+1}`;wrapper.appendChild(link);});return wrapper;}
function renderChart(spec){try{const container=document.createElement("div");container.className="chart-container";const svg=document.createElementNS("http://www.w3.org/2000/svg","svg");svg.setAttribute("viewBox","0 0 640 320");svg.setAttribute("preserveAspectRatio","xMidYMid meet");const margin={top:40,right:40,bottom:50,left:60};const width=640-margin.left-margin.right;const height=320-margin.top-margin.bottom;const data=spec.data?.values||[];const mark=(spec.mark||{}).type||spec.mark||"bar";if(!Array.isArray(data)||!spec.encoding){container.textContent="Chart data unavailable";return container;}const g=document.createElementNS(svg.namespaceURI,"g");g.setAttribute("transform",`translate(${margin.left},${margin.top})`);const encoding=spec.encoding;const xField=encoding.x?.field;const yField=encoding.y?.field;const values=data.map((d)=>({x:d[xField],y:Number(d[yField])||0}));const maxY=Math.max(...values.map((d)=>d.y),1);const barWidth=width/values.length*0.7;values.forEach((d,idx)=>{if(mark==="bar"){const rect=document.createElementNS(svg.namespaceURI,"rect");const barHeight=(d.y/maxY)*height;rect.setAttribute("x",idx*(width/values.length)+(width/values.length-barWidth)/2);rect.setAttribute("y",height-barHeight);rect.setAttribute("width",barWidth);rect.setAttribute("height",barHeight);rect.setAttribute("rx","6");rect.style.fill="url(#barGradient)";g.appendChild(rect);}const label=document.createElementNS(svg.namespaceURI,"text");label.setAttribute("x",idx*(width/values.length)+width/(values.length*2));label.setAttribute("y",height+24);label.setAttribute("text-anchor","middle");label.textContent=String(d.x);label.style.fontSize="12px";label.style.fill="currentColor";g.appendChild(label);});const axis=document.createElementNS(svg.namespaceURI,"line");axis.setAttribute("x1","0");axis.setAttribute("x2",String(width));axis.setAttribute("y1",String(height));axis.setAttribute("y2",String(height));axis.style.stroke="currentColor";axis.style.opacity="0.3";g.appendChild(axis);const grad=document.createElementNS(svg.namespaceURI,"linearGradient");grad.id="barGradient";grad.setAttribute("x1","0");grad.setAttribute("y1","1");grad.setAttribute("x2","0");grad.setAttribute("y2","0");const stop1=document.createElementNS(svg.namespaceURI,"stop");stop1.setAttribute("offset","0%");stop1.style.stopColor="var(--color-accent)";stop1.style.stopOpacity="0.4";const stop2=document.createElementNS(svg.namespaceURI,"stop");stop2.setAttribute("offset","100%");stop2.style.stopColor="var(--color-accent)";stop2.style.stopOpacity="0.85";const defs=document.createElementNS(svg.namespaceURI,"defs");defs.append(grad);grad.append(stop1,stop2);svg.appendChild(defs);svg.appendChild(g);container.appendChild(svg);return container;}catch(error){console.warn("Failed to render chart",error);const fallback=document.createElement("div");fallback.className="chart-container";fallback.textContent="Unable to render chart";return fallback;}}
function handleSubmit(event){event.preventDefault();if(isStreaming)return;const text=elements.messageInput.value.trim();if(!text&&!state.pendingAttachments.length&&!state.pendingVoice){return;}const chat=state.chats[state.currentChatId];if(!chat)return;const userMessage=createMessageObject({role:"user",content:text||"(no text)",attachments:clone(state.pendingAttachments),voice:state.pendingVoice});chat.messages.push(userMessage);chat.updatedAt=Date.now();appendMessageElement(userMessage);state.pendingAttachments=[];state.pendingVoice=null;renderAttachmentPreview();elements.messageInput.value="";autoResize(elements.messageInput);persistState();sendChatRequest(userMessage,chat).catch((error)=>{console.error("Failed to send message",error);presentAssistantError(chat,"Could not reach Adam",userMessage.id);});}
function createMessageObject({id,role,content,attachments,voice,error,metadata}){return{id:id||createId(role||"msg"),role:role||"assistant",content:content||"",attachments:attachments||[],voice:voice||null,error,metadata,createdAt:Date.now(),sources:[],rich:{},needsCollapse:false};}
async function sendChatRequest(userMessage,chat){setStreaming(true);const payload={chat_id:chat.id,text:userMessage.content,files:userMessage.attachments.map((file)=>({name:file.name,type:file.type,data:file.data,size:file.size,kind:file.kind})),voice:userMessage.voice};state.lastPrompt="";persistState();const controller=new AbortController();activeController=controller;try{const response=await fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload),signal:controller.signal});if(!response.ok)throw new Error("Chat request failed");await streamAssistantResponse(response.body,chat,userMessage.id);}catch(error){if(error.name==="AbortError"){console.log("Streaming aborted");}else{console.error(error);presentAssistantError(chat,"âŒ Couldnâ€™t reach Adam",userMessage.id);} }finally{setStreaming(false);}}
async function streamAssistantResponse(body,chat,userMessageId){if(!body)return;const reader=body.getReader();const decoder=new TextDecoder("utf-8");let buffer="";let assistantMessage=null;showTypingIndicator(true);while(true){const {done,value}=await reader.read();if(done)break;buffer+=decoder.decode(value,{stream:true});const lines=buffer.split("\n\n");buffer=lines.pop()||"";for(const chunk of lines){if(!chunk.trim())continue;try{const parsed=JSON.parse(chunk);if(parsed.event==="message_start"){assistantMessage=createMessageObject({role:"assistant",content:""});assistantMessage.responseTo=userMessageId;chat.messages.push(assistantMessage);appendMessageElement(assistantMessage);}else if(parsed.event==="message_delta"&&assistantMessage){appendDelta(assistantMessage,parsed.data||{});}else if(parsed.event==="message_end"&&assistantMessage){finalizeAssistantMessage(assistantMessage,chat,parsed.data||{});assistantMessage=null;}else if(parsed.event==="suggestions"){chat.quickReplies=parsed.data?.suggestions||[];renderQuickReplies(chat);} }catch(error){console.warn("Failed to parse chunk",chunk,error);}}}showTypingIndicator(false);persistState();renderSidebar();}
function appendDelta(message,data){if(data.content){message.content=(message.content||"")+data.content;}if(data.sources){message.sources=data.sources;}if(data.rich){message.rich={...message.rich,...data.rich};}if(data.attachments){message.attachments=(message.attachments||[]).concat(data.attachments);}message.needsCollapse=(message.content?.length||0)>500;appendMessageElement(message);}
function finalizeAssistantMessage(message,chat,data){if(data?.sources)message.sources=data.sources;if(data?.rich)message.rich={...message.rich,...data.rich};if(data?.attachments)message.attachments=(message.attachments||[]).concat(data.attachments);message.createdAt=Date.now();message.needsCollapse=(message.content?.length||0)>500;appendMessageElement(message);chat.updatedAt=Date.now();persistState();}
function presentAssistantError(chat,text,relatedId){const errorMessage=createMessageObject({role:"assistant",content:`${text} The model is busy.`,error:true});errorMessage.responseTo=relatedId;chat.messages.push(errorMessage);appendMessageElement(errorMessage);const retry=document.createElement("button");retry.type="button";retry.className="message__regenerate";retry.textContent="Retry";retry.addEventListener("click",()=>handleRetry(errorMessage));messageElements.get(errorMessage.id)?.querySelector(".message__controls")?.appendChild(retry);persistState();}
function handleRetry(message){if(!message.responseTo)return;const chat=state.chats[state.currentChatId];const original=chat?.messages.find((msg)=>msg.id===message.responseTo);if(!chat||!original)return;handleRegenerate(original);}
function handleRegenerate(message){if(isStreaming)return;const chat=state.chats[state.currentChatId];if(!chat)return;const cloneMessage=createMessageObject({role:"user",content:message.content,attachments:clone(message.attachments||[]),voice:message.voice});chat.messages.push(cloneMessage);appendMessageElement(cloneMessage);persistState();sendChatRequest(cloneMessage,chat).catch((error)=>{console.error(error);presentAssistantError(chat,"âŒ Couldnâ€™t reach Adam",cloneMessage.id);});}
function sendStopRequest(){if(!isStreaming){return;}if(activeController){activeController.abort();}fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"stop",chat_id:state.currentChatId})}).catch(()=>{});setStreaming(false);showTypingIndicator(false);}
function setStreaming(streaming){isStreaming=streaming;elements.sendButton?.setAttribute("data-state",streaming?"streaming":"idle");if(streaming){elements.sendButton?.setAttribute("aria-label","Stop generation");elements.stopStreamButton?.removeAttribute("hidden");}else{elements.sendButton?.setAttribute("aria-label","Send message");elements.stopStreamButton?.setAttribute("hidden","true");}updateSendAvailability();}
function showTypingIndicator(show){if(!elements.typingIndicator)return;elements.typingIndicator.hidden=!show;}
function autoResize(textarea){if(!textarea)return;textarea.style.height="auto";const maxHeight=textarea.dataset.maxHeight||"";const lineHeight=parseInt(window.getComputedStyle(textarea).lineHeight,10)||24;const limit=lineHeight*COMPOSER_MAX_LINES;const newHeight=Math.min(textarea.scrollHeight,limit);textarea.style.height=`${newHeight}px`;textarea.dataset.maxHeight=limit;}
function handleFileSelection(fileList,kind){if(!fileList?.length)return;const tasks=Array.from(fileList).map((file)=>{
if(kind==="file"&&file.size>25*1024*1024){alert(`${file.name} exceeds 25MB limit`);return null;}return readFileAsData(file,kind);});Promise.all(tasks).then((items)=>{items.filter(Boolean).forEach((item)=>state.pendingAttachments.push(item));renderAttachmentPreview();persistState();});if(elements.fileInput)elements.fileInput.value="";if(elements.imageInput)elements.imageInput.value="";}
function readFileAsData(file,kind){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=()=>{const base64=(reader.result||"").split(",").pop();resolve({id:createId("file"),name:file.name,type:file.type,size:file.size,data:base64,kind,preview:kind==="image"?reader.result:null});};reader.onerror=()=>reject(reader.error);if(kind==="image"){reader.readAsDataURL(file);}else{reader.readAsDataURL(file);} });}
function renderAttachmentPreview(){const container=elements.attachmentPreview;if(!container)return;container.innerHTML="";state.pendingAttachments.forEach((item)=>{const chip=document.createElement("div");chip.className="attachment-chip";if(item.preview){const img=document.createElement("img");img.className="attachment-chip__thumb";img.src=item.preview;img.alt=item.name;chip.appendChild(img);}const label=document.createElement("span");label.textContent=`${item.name} Â· ${formatBytes(item.size)}`;const remove=document.createElement("button");remove.type="button";remove.className="attachment-chip__remove";remove.setAttribute("aria-label","Remove attachment");remove.textContent="âœ•";remove.addEventListener("click",()=>removeAttachment(item.id));chip.append(label,remove);container.appendChild(chip);});}
function removeAttachment(id){state.pendingAttachments=state.pendingAttachments.filter((item)=>item.id!==id);renderAttachmentPreview();persistState();}
async function toggleVoiceRecording(){if(voiceRecorder&&voiceRecorder.state!=="inactive"){voiceRecorder.stop();return;}try{const stream=await navigator.mediaDevices.getUserMedia({audio:true});voiceChunks=[];voiceRecorder=new MediaRecorder(stream,{mimeType:"audio/webm"});voiceRecorder.addEventListener("dataavailable",(event)=>{if(event.data.size>0){voiceChunks.push(event.data);}});voiceRecorder.addEventListener("stop",onVoiceRecordingStop);voiceRecorder.start();elements.voiceButton?.classList.add("is-recording");}catch(error){console.warn("Voice recording not available",error);alert("Unable to access microphone");}}
async function onVoiceRecordingStop(){elements.voiceButton?.classList.remove("is-recording");const blob=new Blob(voiceChunks,{type:"audio/webm"});const array=await blob.arrayBuffer();const base64=base64FromBuffer(array);state.pendingVoice={mimeType:"audio/webm",data:base64,size:blob.size};renderAttachmentPreview();try{const transcript=await fetch("/transcribe",{method:"POST",body:blob});if(transcript.ok){const text=await transcript.text();elements.messageInput.value=(elements.messageInput.value?elements.messageInput.value+" ":"")+text.trim();autoResize(elements.messageInput);}}catch(error){console.warn("Transcription failed",error);}voiceChunks=[];}
function sendStopRecording(){if(voiceRecorder&&voiceRecorder.state!=="inactive"){voiceRecorder.stop();}}
function renderMarkdown(container,markdown){if(!markdown){container.textContent="";return;}const blocks=parseMarkdown(markdown);blocks.forEach((block)=>container.appendChild(block));}
function parseMarkdown(text){const lines=text.split(/\n{2,}/);return lines.map((chunk)=>renderBlock(chunk.trim())).filter(Boolean);}
function renderBlock(chunk){if(!chunk)return null;if(/^```/.test(chunk)){return renderCodeBlock(chunk);}if(/^\|/.test(chunk)){return renderTable(chunk);}if(/^\d+\.\s/.test(chunk)){return renderList(chunk,true);}if(/^[-*+]\s/.test(chunk)){return renderList(chunk,false);}if(/^#+\s/.test(chunk)){const level=chunk.match(/^#+/)[0].length;const heading=document.createElement(`h${Math.min(level,4)}`);heading.textContent=chunk.replace(/^#+\s*/,"");return heading;}const paragraph=document.createElement("p");renderInline(paragraph,chunk);return paragraph;}
function renderInline(container,text){const regex=/(\*\*|__)(.*?)\1|(`)(.*?)`|!\[(.*?)\]\((.*?)\)|\[(.*?)\]\((.*?)\)/g;let lastIndex=0;let match;while((match=regex.exec(text))){if(match.index>lastIndex){container.appendChild(document.createTextNode(text.slice(lastIndex,match.index)));}if(match[1]){const strong=document.createElement("strong");strong.textContent=match[2];container.appendChild(strong);}else if(match[3]){const code=document.createElement("code");code.textContent=match[4];container.appendChild(code);}else if(match[5]){const span=document.createElement("span");span.textContent=`[Image: ${match[5]}]`;container.appendChild(span);}else if(match[7]){const link=document.createElement("a");const href=sanitizeUrl(match[8]);link.href=href;link.target="_blank";link.rel="noopener";link.textContent=match[7];container.appendChild(link);}lastIndex=match.index+match[0].length;}if(lastIndex<text.length){container.appendChild(document.createTextNode(text.slice(lastIndex)));}}
function renderList(chunk,ordered){const list=document.createElement(ordered?"ol":"ul");chunk.split(/\n/).forEach((line)=>{const item=document.createElement("li");const content=line.replace(/^([-*+]|\d+\.)\s*/,"");renderInline(item,content);list.appendChild(item);});return list;}
function renderCodeBlock(chunk){const [,lang="",...rest]=chunk.split(/```/);const code=document.createElement("pre");code.className="code-block";code.dataset.language=lang.trim()||"text";const inner=document.createElement("code");inner.textContent=rest.join("```").replace(/^\n+|\n+$/g,"");code.appendChild(inner);const copy=document.createElement("button");copy.type="button";copy.className="code-block__copy";copy.textContent="ðŸ“‹ Copy";copy.addEventListener("click",()=>handleCopy(inner,copy));code.appendChild(copy);applySyntaxHighlight(inner,lang.trim());return code;}
function renderTable(chunk){const table=document.createElement("table");const rows=chunk.split(/\n/).map((row)=>row.split("|").slice(1,-1).map((cell)=>cell.trim()));const [header,...body]=rows;const thead=document.createElement("thead");const headRow=document.createElement("tr");header.forEach((cell)=>{const th=document.createElement("th");th.textContent=cell;headRow.appendChild(th);});thead.appendChild(headRow);table.appendChild(thead);const tbody=document.createElement("tbody");body.forEach((cells)=>{const tr=document.createElement("tr");cells.forEach((cell)=>{const td=document.createElement("td");td.textContent=cell;tr.appendChild(td);});tbody.appendChild(tr);});table.appendChild(tbody);return table;}
function sanitizeUrl(url){try{const parsed=new URL(url,window.location.origin);if(parsed.protocol==="javascript:"){return"";}return parsed.href;}catch{return"";}}
function applySyntaxHighlight(codeElement,language){const lang=(language||"plaintext").toLowerCase();const source=codeElement.textContent||"";const sanitized=escapeHtml(source);const keywordPattern=HIGHLIGHT_KEYWORDS[lang];const parts=["(?<comment>#.*$|//.*$|/\\*[\\s\\S]*?\\*/)","(?<string>\"(?:\\\\.|[^\"\\])*\"|'(?:\\\\.|[^'\\])*')","(?<number>\\b0x[0-9a-fA-F]+\\b|\\b\\d+(?:\\.\\d+)?\\b)"];if(keywordPattern){parts.push(`(?<keyword>\\b(?:${keywordPattern})\\b)`);}const composite=new RegExp(parts.join("|"),"gm");const highlighted=sanitized.replace(composite,(match,...rest)=>{const groups=rest.at(-1);if(groups.comment){return `<span class=\"code-token-comment\">${match}</span>`;}if(groups.string){return `<span class=\"code-token-string\">${match}</span>`;}if(groups.number){return `<span class=\"code-token-number\">${match}</span>`;}if(groups.keyword){return `<span class=\"code-token-keyword\">${match}</span>`;}return match;});codeElement.innerHTML=highlighted;}
const HIGHLIGHT_KEYWORDS={python:"False|class|finally|is|return|None|continue|for|lambda|try|True|def|from|nonlocal|while|and|del|global|not|with|as|elif|if|or|yield|assert|else|import|pass|break|except|in|raise",javascript:"break|case|catch|class|const|continue|debugger|default|delete|do|else|export|extends|finally|for|function|if|import|in|instanceof|let|new|return|super|switch|this|throw|try|typeof|var|void|while|with|yield",typescript:"abstract|any|as|boolean|break|case|catch|class|const|constructor|continue|declare|default|delete|do|else|enum|export|extends|false|finally|for|from|function|get|if|implements|import|in|infer|instanceof|interface|is|keyof|let|module|namespace|never|new|null|number|of|package|private|protected|public|readonly|require|return|set|static|string|super|switch|symbol|this|throw|true|try|typeof|undefined|unique|unknown|var|void|while|with",json:"true|false|null",bash:"if|then|fi|else|elif|for|in|do|done|case|esac|while|until|function"};
function escapeHtml(text){return(text||"").replace(/[&<>]/g,(char)=>{switch(char){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";default:return char;}});}
function formatRelative(timestamp){try{const formatter=new Intl.RelativeTimeFormat(undefined,{numeric:"auto"});const diff=timestamp-Date.now();const minutes=Math.round(diff/60000);if(Math.abs(minutes)<60){return formatter.format(minutes,"minute");}const hours=Math.round(diff/3600000);if(Math.abs(hours)<24){return formatter.format(hours,"hour");}const days=Math.round(diff/86400000);return formatter.format(days,"day");}catch{return new Date(timestamp).toLocaleString();}}
function formatBytes(bytes){if(!bytes)return"0 B";const units=["B","KB","MB","GB"];let index=0;let value=bytes;while(value>=1024&&index<units.length-1){value/=1024;index++;}return `${value.toFixed(index?1:0)} ${units[index]}`;}
function createId(prefix){return `${prefix}_${Math.random().toString(16).slice(2,10)}`;}
function base64FromBuffer(buffer){const bytes=new Uint8Array(buffer);let binary="";bytes.forEach((b)=>binary+=String.fromCharCode(b));return btoa(binary);}
function scheduleHeartbeat(immediate=false){if(heartbeatTimer)window.clearTimeout(heartbeatTimer);const execute=async()=>{await checkHealth();heartbeatTimer=window.setTimeout(execute,HEARTBEAT_INTERVAL);};if(immediate){execute();}else{heartbeatTimer=window.setTimeout(execute,HEARTBEAT_INTERVAL);}}
async function checkHealth(){try{const response=await fetch("/health",{cache:"no-store"});if(!response.ok)throw new Error("Health check failed");const data=await response.json();setApiStatus(data.status==="ok");}catch(error){setApiStatus(false);}}
function setApiStatus(online){const status=online?"online":"offline";elements.apiStatusDot?.setAttribute("data-status",status);elements.apiStatusLabel&&(elements.apiStatusLabel.textContent=online?"Online":"Offline");elements.settingsStatusDot?.setAttribute("data-status",status);elements.settingsStatusLabel&&(elements.settingsStatusLabel.textContent=online?"Online":"Offline");if(!online){showOfflineTooltip();}else{hideOfflineTooltip();}updateSendAvailability();}
function updateConnectivity(){setApiStatus(navigator.onLine);updateSendAvailability();}
function updateSendAvailability(){const disabled=!navigator.onLine&& !isStreaming;elements.sendButton&&(elements.sendButton.disabled=!navigator.onLine&&!isStreaming);if(!navigator.onLine){showOfflineTooltip();}else{hideOfflineTooltip();}}
function showOfflineTooltip(){if(offlineTooltip||navigator.onLine)return;offlineTooltip=document.createElement("div");offlineTooltip.className="offline-tooltip";offlineTooltip.textContent="No connection";elements.app.appendChild(offlineTooltip);}
function hideOfflineTooltip(){if(offlineTooltip){offlineTooltip.remove();offlineTooltip=null;}}
function syncComposerState(){if(!elements.messageInput)return;elements.messageInput.value=state.lastPrompt||"";autoResize(elements.messageInput);renderAttachmentPreview();applySidebarCollapsedState();}
function applyTheme(theme,save=true){const resolved=theme==="system"?getSystemTheme():theme;elements.app.dataset.theme=theme;document.documentElement.dataset.theme=resolved;if(save){state.preferences.theme=theme;persistState();}}
function getSystemTheme(){return window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";}
async function fetchQuickReplies(){try{const response=await fetch("/quick_replies");if(!response.ok)return;const data=await response.json();if(Array.isArray(data.replies)){state.quickReplies=data.replies;persistState();renderQuickReplies(state.chats[state.currentChatId]||{});}}catch(error){console.warn("Failed quick replies",error);}}
window.addEventListener("beforeunload",()=>{sendStopRecording();if(isStreaming){sendStopRequest();}});
})();
